image: maven:3.9.6-eclipse-temurin-17

stages:
  - build
  - test-api
  - test-ui
  - test-performance

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository/
    - node_modules/

# =============================================
# STAGE 1: BUILD
# =============================================
build:
  stage: build
  script:
    - echo "Building project..."
    - mvn clean compile -DskipTests
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

# =============================================
# STAGE 2: API TESTS (Postman/Newman)
# =============================================
test_api_newman:
  stage: test-api
  image: node:20
  script:
    - echo "Installing Newman..."
    - npm install -g newman newman-reporter-htmlextra
    - echo "Running Postman/Newman API tests..."
    - newman run postman/PokeAPI_Collection.json -e postman/PokeAPI_Environment.json --reporters cli,junit,htmlextra --reporter-junit-export results/newman-junit.xml --reporter-htmlextra-export results/newman-report.html
  artifacts:
    when: always
    paths:
      - results/
    reports:
      junit: results/newman-junit.xml
    expire_in: 1 week

test_api_java:
  stage: test-api
  image: maven:3.9.6-eclipse-temurin-17
  script:
    - echo "Running REST Assured API tests..."
    - mvn test -Dtest=api.PokeAPITest
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
    reports:
      junit: target/surefire-reports/*.xml
    expire_in: 1 week

# =============================================
# STAGE 3: UI TESTS (Selenium)
# =============================================
test_ui_selenium:
  stage: test-ui
  image: maven:3.9.6-eclipse-temurin-17
  services:
    - name: selenium/standalone-chrome:latest
      alias: selenium
  variables:
    SELENIUM_REMOTE_URL: "http://selenium:4444/wd/hub"
    CI: "true"
  script:
    - echo "Running Selenium UI tests..."
    - mvn test -Dtest=selenium.PokeAPIWebTest
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
    reports:
      junit: target/surefire-reports/*.xml
    expire_in: 1 week
  allow_failure: true

# =============================================
# STAGE 4: PERFORMANCE TESTS (JMeter)
# =============================================
test_performance_jmeter:
  stage: test-performance
  image: eclipse-temurin:11-jdk
  before_script:
    - apt-get update && apt-get install -y wget
    - wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.5.tgz
    - tar -xzf apache-jmeter-5.5.tgz
  script:
    - echo "Running JMeter performance tests..."
    - apache-jmeter-5.5/bin/jmeter -n -t jmeter/pokeapi_performance_test.jmx -l jmeter/results.jtl -j jmeter/jmeter.log
    - echo "Generating HTML report..."
    - apache-jmeter-5.5/bin/jmeter -g jmeter/results.jtl -o jmeter/report
    - echo "Performance tests completed!"
  artifacts:
    when: always
    paths:
      - jmeter/report/
      - jmeter/results.jtl
      - jmeter/jmeter.log
    expire_in: 1 week
  allow_failure: true
