# ===================================
# Pipeline CI/CD - Tests Complets
# Selenium | Postman | JMeter | Chaos
# ===================================

stages:
  - selenium_tests      # Tests fonctionnels UI
  - postman_tests       # Tests API/intÃ©gration
  - performance_tests   # Tests de charge JMeter
  - chaos_tests         # Tests de fiabilitÃ©/sÃ©curitÃ©
  - publish_reports     # GÃ©nÃ©ration rapports consolidÃ©s

# ===================================
# Variables globales
# ===================================
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  REPORTS_DIR: "reports"

# ===================================
# Cache Maven pour Selenium
# ===================================
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository

# ===================================
# STAGE 1 : Tests Selenium (UI)
# ===================================
selenium_ui_tests:
  stage: selenium_tests
  image: maven:3.9.6-eclipse-temurin-17
  services:
    - name: selenium/standalone-chrome:latest
      alias: chrome
  script:
    - echo "ğŸ” ExÃ©cution des tests Selenium..."
    - cd selenium
    - mvn clean test -Dtest=LoginSuccess,LoginAdvanced
    - echo "âœ… Tests Selenium terminÃ©s"
  artifacts:
    when: always
    paths:
      - selenium/target/surefire-reports/
    reports:
      junit: selenium/target/surefire-reports/TEST-*.xml
    expire_in: 7 days
  allow_failure: false
  only:
    - main
    - develop
    - merge_requests

# ===================================
# STAGE 2 : Tests Postman (API)
# ===================================
postman_api_tests:
  stage: postman_tests
  image: postman/newman:alpine
  script:
    - echo "ğŸ” ExÃ©cution des tests API Postman..."
    - cd postman
    # Installation de newman-reporter-htmlextra pour rapports HTML
    - npm install -g newman-reporter-htmlextra
    - |
      newman run collection.json \
        --reporters cli,junit,htmlextra \
        --reporter-junit-export ../reports/postman-results.xml \
        --reporter-htmlextra-export ../reports/postman-report.html
    - echo "âœ… Tests API terminÃ©s"
  artifacts:
    when: always
    paths:
      - reports/postman-report.html
      - reports/postman-results.xml
    reports:
      junit: reports/postman-results.xml
    expire_in: 7 days
  allow_failure: false
  only:
    - main
    - develop
    - merge_requests

# ===================================
# STAGE 3 : Tests JMeter (Performance)
# ===================================
jmeter_performance_tests:
  stage: performance_tests
  image: justb4/jmeter:5.7.1
  script:
    - echo "âš¡ ExÃ©cution des tests de performance JMeter..."
    - cd jmeter
    - |
      jmeter -n \
        -t td_performance_test.jmx \
        -l ../reports/jmeter-results.jtl \
        -e -o ../reports/jmeter-report \
        -Jjmeter.reportgenerator.overall_granularity=1000
    - echo "âœ… Tests de performance terminÃ©s"
    # Affichage statistiques clÃ©s
    - echo "ğŸ“Š Statistiques de performance :"
    - tail -n 20 ../reports/jmeter-results.jtl
  artifacts:
    when: always
    paths:
      - reports/jmeter-report/
      - reports/jmeter-results.jtl
    expire_in: 7 days
  allow_failure: true  # Ne bloque pas le pipeline si les perfs sont dÃ©gradÃ©es
  only:
    - main
    - develop
    - merge_requests

# ===================================
# STAGE 4 : Tests Chaos Toolkit
# ===================================
chaos_reliability_tests:
  stage: chaos_tests
  image: python:3.11-slim
  before_script:
    - echo "ğŸ”§ Installation Chaos Toolkit..."
    - pip install --quiet chaostoolkit chaostoolkit-http psutil
  script:
    - echo "ğŸ§ª ExÃ©cution des tests de fiabilitÃ©..."
    - cd chaos
    # Test HTTP disponibilitÃ©
    - chaos run http_test.json --journal-path=../reports/chaos-http.json || true
    # Test surcharge CPU
    - chaos run cpu_test.json --journal-path=../reports/chaos-cpu.json || true
    # Test sÃ©curitÃ© authentification
    - chaos run auth_test.json --journal-path=../reports/chaos-auth.json || true
    - echo "âœ… Tests de fiabilitÃ© terminÃ©s"
  artifacts:
    when: always
    paths:
      - reports/chaos-*.json
    expire_in: 7 days
  allow_failure: true  # Tests exploratoires, ne bloquent pas
  only:
    - main
    - develop

# ===================================
# STAGE 5 : Publication Rapports
# ===================================
publish_consolidated_reports:
  stage: publish_reports
  image: alpine:latest
  dependencies:
    - selenium_ui_tests
    - postman_api_tests
    - jmeter_performance_tests
    - chaos_reliability_tests
  script:
    - echo "ğŸ“¦ Consolidation des rapports..."
    - |
      cat > reports/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Rapports de Tests CI/CD</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
          h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
          .report-card { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .report-card h2 { color: #4CAF50; margin-top: 0; }
          a { color: #2196F3; text-decoration: none; font-weight: bold; }
          a:hover { text-decoration: underline; }
        </style>
      </head>
      <body>
        <h1>ğŸ¯ Rapports de Tests CI/CD - Pipeline #${CI_PIPELINE_ID}</h1>
        <p><strong>Branch :</strong> ${CI_COMMIT_REF_NAME} | <strong>Commit :</strong> ${CI_COMMIT_SHORT_SHA}</p>
        
        <div class="report-card">
          <h2>ğŸ” Tests Selenium (UI)</h2>
          <p>Tests fonctionnels de l'interface utilisateur</p>
          <a href="selenium/target/surefire-reports/">ğŸ“‚ Voir les rapports Selenium</a>
        </div>

        <div class="report-card">
          <h2>ğŸŒ Tests Postman (API)</h2>
          <p>Tests d'intÃ©gration et validation des endpoints</p>
          <a href="postman-report.html">ğŸ“Š Rapport Postman HTML</a>
        </div>

        <div class="report-card">
          <h2>âš¡ Tests JMeter (Performance)</h2>
          <p>Tests de charge et de performance</p>
          <a href="jmeter-report/index.html">ğŸ“ˆ Dashboard JMeter</a>
        </div>

        <div class="report-card">
          <h2>ğŸ§ª Tests Chaos Toolkit</h2>
          <p>Tests de fiabilitÃ© et de sÃ©curitÃ©</p>
          <a href="chaos-http.json">ğŸ“„ Rapport HTTP</a> | 
          <a href="chaos-cpu.json">ğŸ“„ Rapport CPU</a> | 
          <a href="chaos-auth.json">ğŸ“„ Rapport Auth</a>
        </div>
      </body>
      </html>
      EOF
    - echo "âœ… Page d'accueil des rapports gÃ©nÃ©rÃ©e"
  artifacts:
    paths:
      - reports/
    expire_in: 30 days
  only:
    - main
    - develop

# ===================================
# Job optionnel : Tests en environnement de staging
# ===================================
deploy_to_staging:
  stage: .post
  script:
    - echo "ğŸš€ DÃ©ploiement en staging aprÃ¨s succÃ¨s des tests..."
    # Ajouter vos commandes de dÃ©ploiement ici
  only:
    - main
  when: on_success
